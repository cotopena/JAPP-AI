#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VENV_PY="$ROOT_DIR/.venv-pdf/bin/python"
RENDER_SCRIPT="$ROOT_DIR/scripts/render_markdown_pdf.py"

if [[ "${1-}" == "--setup" ]]; then
  python3 -m venv "$ROOT_DIR/.venv-pdf"
  "$VENV_PY" -m pip install -r "$ROOT_DIR/scripts/requirements_pdf.txt"
  "$VENV_PY" -m playwright install chromium
  echo "mdtopdf setup complete."
  exit 0
fi

if [[ ! -x "$VENV_PY" ]]; then
  cat <<EOF
PDF environment not found.
Run:
  $ROOT_DIR/scripts/mdtopdf --setup
EOF
  exit 1
fi

if [[ ! -f "$RENDER_SCRIPT" ]]; then
  echo "Renderer missing: $RENDER_SCRIPT"
  exit 1
fi

exec "$VENV_PY" "$RENDER_SCRIPT" "$@"
